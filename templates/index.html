<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script
      src="https://cdn.socket.io/4.7.5/socket.io.min.js"
      integrity="sha384-2huaZvOR9iDzHqslqwpR87isEmrfxqyWOF7hr7BY6KG0+hVKLoEXMPUJw3ynWuhO"
      crossorigin="anonymous"
    ></script>
    <script>
      var socket;

      socket = io({
        transports: ["websocket"],
      });

      socket.on("connect", function () {
        console.log("Connected to the server!");
      });

      socket.on("disconnect", function () {
        console.log("Disconnected from the server!");
      });

      socket.on("connect_error", function (error) {
        console.log("Connection Failed!");
      });

      document.addEventListener("DOMContentLoaded", function () {
        document.getElementById("card-list").innerHTML = "";
        showMemos();
      });

      function showMemos() {
        const cardList = document.getElementById("card-list");
        cardList.innerHTML = "";

        const fragment = document.createDocumentFragment();
        fetch("/api/memos", { method: "GET" })
          .then((res) => {
            return res.json();
          })
          .then((data) => {
            for (let i = 0; i < data.length; i++) {
              const cardElement = makeCard(
                data[i]._id,
                data[i].title,
                data[i].content,
                data[i].likes
              );
              fragment.appendChild(cardElement);
            }
            cardList.appendChild(fragment);
          });
      }

      function postMemo(event) {
        event.preventDefault();
        const title = document.getElementById("memo-title");
        const content = document.getElementById("memo-content");

        fetch("/api/memos", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ title: title.value, content: content.value }),
        })
          .then((res) => {
            return res.json();
          })
          .then((data) => {
            if (data.message) {
              alert(data.message);
            } else {
              alert("포스팅 성공!");
              title.value = "";
              content.value = "";
              // document.getElementById("card-list").innerHTML = "";
              showMemos();
              // window.location.reload();
            }
          })
          .catch((e) => {
            alert(e.message);
          });
      }

      function editMemoData(id) {
        const card = document.getElementById(`card-${id}`);
        const card_title = document.getElementById(
          `card-title-${id}`
        ).innerText;
        const card_content = document.getElementById(
          `card-content-${id}`
        ).innerText;

        card.innerHTML = `<div id="card-${id}" class="card">
                            <div class="card-body">
                              <input id="input-title-${id}" class="new-title form-control" value="${card_title}"/>
                              <textarea id="textarea-content-${id}" class="new-text form-control" rows="2">${card_content}</textarea>
                            </div>
                            <div class="card-footer">
                              <button type="button" class="save-button btn btn-success" onclick="sendUpdateMemo('${id}')">
                                저장
                              </button>
                            </div>
                          </div>`;
      }

      function sendUpdateMemo(id) {
        const updatedTitle = document.getElementById(`input-title-${id}`).value;
        const updatedContent = document.getElementById(
          `textarea-content-${id}`
        ).value;

        updateMemo(id, updatedTitle, updatedContent);
      }

      function updateMemo(id, title, content) {
        fetch(`/api/memos/${id}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ title, content }),
        })
          .then((res) => {
            if (!res.ok) {
              throw new Error("서버 오류!");
            }
            alert("수정 완료!");
            // document.getElementById("card-list").innerHTML = "";
            showMemos();
            // window.location.reload();
            return res.json();
          })
          .catch((e) => {
            alert(e.message);
          });
      }

      function deleteMemo(id) {
        fetch(`/api/memos/${id}`, {
          method: "DELETE",
        })
          .then((res) => {
            if (!res.ok) {
              throw new Error("서버 오류!");
            }
            alert("삭제 완료!");
            // document.getElementById("card-list").innerHTML = "";
            showMemos();
            // window.location.reload();
            return res.json();
          })
          .catch((e) => {
            alert(e.message);
          });
      }

      function likeMemo(id) {
        fetch(`/api/memos/likes/${id}`, {
          method: "PATCH",
        })
          .then((res) => {
            if (!res.ok) {
              throw new Error("서버 오류!");
            }
            // document.getElementById("card-list").innerHTML = "";
            showMemos();
            // window.location.reload();
            return res.json();
          })
          .catch((e) => {
            alert(e.message);
          });
      }

      function makeCard(id, title, content, likes) {
        const tempDiv = document.createElement("div");
        tempDiv.className = "col";
        // tempDiv.innerHTML = `<div class="card" id="card-${id}">
        //                     <div class="card-body">
        //                       <h5 class="card-title" id="card-title-${id}">${title}</h5>
        //                       <p class="card-text" id="card-content-${id}">${content}</p>
        //                         <a href="#" style="text-decoration: none;" class="link-like d-flex align-items-center icon-link" onclick="likeMemo('${id}')">
        //                           <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-hand-thumbs-up" viewBox="0 0 16 16">
        //                             <path d="M8.864.046C7.908-.193 7.02.53 6.956 1.466c-.072 1.051-.23 2.016-.428 2.59-.125.36-.479 1.013-1.04 1.639-.557.623-1.282 1.178-2.131 1.41C2.685 7.288 2 7.87 2 8.72v4.001c0 .845.682 1.464 1.448 1.545 1.07.114 1.564.415 2.068.723l.048.03c.272.165.578.348.97.484.397.136.861.217 1.466.217h3.5c.937 0 1.599-.477 1.934-1.064a1.86 1.86 0 0 0 .254-.912c0-.152-.023-.312-.077-.464.201-.263.38-.578.488-.901.11-.33.172-.762.004-1.149.069-.13.12-.269.159-.403.077-.27.113-.568.113-.857 0-.288-.036-.585-.113-.856a2 2 0 0 0-.138-.362 1.9 1.9 0 0 0 .234-1.734c-.206-.592-.682-1.1-1.2-1.272-.847-.282-1.803-.276-2.516-.211a10 10 0 0 0-.443.05 9.4 9.4 0 0 0-.062-4.509A1.38 1.38 0 0 0 9.125.111zM11.5 14.721H8c-.51 0-.863-.069-1.14-.164-.281-.097-.506-.228-.776-.393l-.04-.024c-.555-.339-1.198-.731-2.49-.868-.333-.036-.554-.29-.554-.55V8.72c0-.254.226-.543.62-.65 1.095-.3 1.977-.996 2.614-1.708.635-.71 1.064-1.475 1.238-1.978.243-.7.407-1.768.482-2.85.025-.362.36-.594.667-.518l.262.066c.16.04.258.143.288.255a8.34 8.34 0 0 1-.145 4.725.5.5 0 0 0 .595.644l.003-.001.014-.003.058-.014a9 9 0 0 1 1.036-.157c.663-.06 1.457-.054 2.11.164.175.058.45.3.57.65.107.308.087.67-.266 1.022l-.353.353.353.354c.043.043.105.141.154.315.048.167.075.37.075.581 0 .212-.027.414-.075.582-.05.174-.111.272-.154.315l-.353.353.353.354c.047.047.109.177.005.488a2.2 2.2 0 0 1-.505.805l-.353.353.353.354c.006.005.041.05.041.17a.9.9 0 0 1-.121.416c-.165.288-.503.56-1.066.56z"/>
        //                           </svg>
        //                           <h6 class="card-likes card-text ms-1">
        //                             ${likes}
        //                           </h6>
        //                         </a>
        //                     </div>
        //                     <div class="card-footer">
        //                       <button type="button" class="edit-button btn btn-info" onclick="editMemoData('${id}')">
        //                         수정
        //                       </button>
        //                       <button type="button" class="delete-button btn btn-danger" onclick="deleteMemo('${id}')">
        //                         삭제
        //                       </button>
        //                     </div>
        //                   </div>`;
        // return tempDiv;

        const cardDiv = document.createElement("div");
        cardDiv.className = "card";
        cardDiv.id = `card-${id}`;

        const cardBodyDiv = document.createElement("div");
        cardBodyDiv.className = "card-body";

        const cardTitle = document.createElement("h5");
        cardTitle.className = "card-title";
        cardTitle.id = `card-title-${id}`;
        cardTitle.textContent = title; // XSS 방지

        const cardText = document.createElement("p");
        cardText.className = "card-text";
        cardText.id = `card-content-${id}`;
        cardText.textContent = content; // XSS 방지

        const likeLink = document.createElement("a");
        likeLink.href = "#";
        likeLink.className = "link-like d-flex align-items-center icon-link";
        likeLink.onclick = () => likeMemo(id);

        const likeIcon = document.createElementNS(
          "http://www.w3.org/2000/svg",
          "svg"
        );
        likeIcon.setAttribute("width", "16");
        likeIcon.setAttribute("height", "16");
        likeIcon.setAttribute("fill", "currentColor");
        likeIcon.setAttribute("class", "bi bi-hand-thumbs-up");
        likeIcon.setAttribute("viewBox", "0 0 16 16");

        const svgPath = document.createElementNS(
          "http://www.w3.org/2000/svg",
          "path"
        );
        svgPath.setAttribute(
          "d",
          "M8.864.046C7.908-.193 7.02.53 6.956 1.466c-.072 1.051-.23 2.016-.428 2.59-.125.36-.479 1.013-1.04 1.639-.557.623-1.282 1.178-2.131 1.41C2.685 7.288 2 7.87 2 8.72v4.001c0 .845.682 1.464 1.448 1.545 1.07.114 1.564.415 2.068.723l.048.03c.272.165.578.348.97.484.397.136.861.217 1.466.217h3.5c.937 0 1.599-.477 1.934-1.064a1.86 1.86 0 0 0 .254-.912c0-.152-.023-.312-.077-.464.201-.263.38-.578.488-.901.11-.33.172-.762.004-1.149.069-.13.12-.269.159-.403.077-.27.113-.568.113-.857 0-.288-.036-.585-.113-.856a2 2 0 0 0-.138-.362 1.9 1.9 0 0 0 .234-1.734c-.206-.592-.682-1.1-1.2-1.272-.847-.282-1.803-.276-2.516-.211a10 10 0 0 0-.443.05 9.4 9.4 0 0 0-.062-4.509A1.38 1.38 0 0 0 9.125.111zM11.5 14.721H8c-.51 0-.863-.069-1.14-.164-.281-.097-.506-.228-.776-.393l-.04-.024c-.555-.339-1.198-.731-2.49-.868-.333-.036-.554-.29-.554-.55V8.72c0-.254.226-.543.62-.65 1.095-.3 1.977-.996 2.614-1.708.635-.71 1.064-1.475 1.238-1.978.243-.7.407-1.768.482-2.85.025-.362.36-.594.667-.518l.262.066c.16.04.258.143.288.255a8.34 8.34 0 0 1-.145 4.725.5.5 0 0 0 .595.644l.003-.001.014-.003.058-.014a9 9 0 0 1 1.036-.157c.663-.06 1.457-.054 2.11.164.175.058.45.3.57.65.107.308.087.67-.266 1.022l-.353.353.353.354c.043.043.105.141.154.315.048.167.075.37.075.581 0 .212-.027.414-.075.582-.05.174-.111.272-.154.315l-.353.353.353.354c.047.047.109.177.005.488a2.2 2.2 0 0 1-.505.805l-.353.353.353.354c.006.005.041.05.041.17a.9.9 0 0 1-.121.416c-.165.288-.503.56-1.066.56z"
        );

        likeIcon.appendChild(svgPath);

        const likesCount = document.createElement("h6");
        likesCount.className = "card-likes card-text ms-1";
        likesCount.textContent = likes;

        likeLink.appendChild(likeIcon);
        likeLink.appendChild(likesCount);

        cardBodyDiv.appendChild(cardTitle);
        cardBodyDiv.appendChild(cardText);
        cardBodyDiv.appendChild(likeLink);

        const cardFooter = document.createElement("div");
        cardFooter.className = "card-footer";

        const editButton = document.createElement("button");
        editButton.type = "button";
        editButton.className = "edit-button btn btn-info";
        editButton.textContent = "수정";
        editButton.onclick = () => editMemoData(id);

        const deleteButton = document.createElement("button");
        deleteButton.type = "button";
        deleteButton.className = "delete-button btn btn-danger";
        deleteButton.textContent = "삭제";
        deleteButton.onclick = () => deleteMemo(id);

        cardFooter.appendChild(editButton);
        cardFooter.appendChild(deleteButton);

        cardDiv.appendChild(cardBodyDiv);
        cardDiv.appendChild(cardFooter);

        tempDiv.appendChild(cardDiv);

        return tempDiv;
      }
    </script>

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Jua&display=swap"
      rel="stylesheet"
    />

    <style type="text/css">
      * {
        font-family: "Jua", sans-serif;
        font-weight: 400;
        font-style: normal;
      }
    </style>

    <title>Gikhub</title>
  </head>
  <body>
    <div class="container">
      <div class="d-flex flex-column">
        <div class="p-2">
          <h1>긱허브</h1>
        </div>
        <div class="p-2">
          <form class="row row-cols-1 g-3 border border-dark rounded p-3 mb-4">
            <div class="col">
              <input
                id="memo-title"
                class="form-control"
                placeholder="제목을 입력하세요"
              />
            </div>
            <div class="col">
              <textarea
                id="memo-content"
                class="form-control"
                rows="2"
                placeholder="내용을 입력하세요"
              ></textarea>
            </div>
            <div class="col">
              <button
                type="submit"
                class="btn btn-primary"
                onclick="postMemo(event)"
              >
                저장하기
              </button>
            </div>
          </form>
        </div>
        <div
          id="card-list"
          class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-lg-4 g-4"
        ></div>
      </div>
    </div>
  </body>
</html>
